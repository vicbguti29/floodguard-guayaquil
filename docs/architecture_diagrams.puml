@startuml FloodGuard_Architecture_Complete

!define RECTANGLE class

skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title FloodGuard - Arquitectura Completa Transformer + GNN\n(PredicciÃ³n de Inundaciones Guayaquil)

' ============================================
' INPUTS
' ============================================
package "ğŸ“Š DATOS DE ENTRADA" as inputs {
    rectangle "Series Temporales\nMeteorolÃ³gicas" as weather_data {
        [PrecipitaciÃ³n (mm/h)]
        [Temperatura (Â°C)]
        [Humedad (%)]
        [Velocidad viento (km/h)]
    }

    rectangle "Datos Geoespaciales" as geo_data {
        [TopografÃ­a (elevaciÃ³n)]
        [Red de alcantarillado]
        [Cuerpos de agua]
        [Zonas de Guayaquil]
    }

    note right of weather_data
        **Frecuencia:** Cada hora
        **Ventana:** Ãšltimas 24h
        **Fuente:** INAMHI/INOCAR
    end note

    note right of geo_data
        **ResoluciÃ³n:** Grid 2km x 2km
        **Zonas:** 840 celdas
        **Fuente:** OpenStreetMap
    end note
}

' ============================================
' TRANSFORMER TEMPORAL
' ============================================
package "ğŸ”„ TRANSFORMER TEMPORAL" as transformer {
    rectangle "Input Embedding" as embed {
        [Positional Encoding\n(Time-aware)]
        [Feature Embedding\n4D â†’ 128D]
    }

    rectangle "Multi-Head\nSelf-Attention" as attention {
        [Query (Q)]
        [Key (K)]
        [Value (V)]
        ---
        [Attention(Q,K,V) = softmax(QK^T/âˆšd)V]
    }

    rectangle "Feed-Forward\nNetwork" as ffn {
        [Linear 128â†’512]
        [ReLU]
        [Linear 512â†’128]
    }

    rectangle "Transformer\nEncoder Stack" as encoder {
        [Layer 1: Attention + FFN]
        [Layer 2: Attention + FFN]
        [...N capas...]
    }

    rectangle "Output Projection" as proj {
        [PredicciÃ³n prÃ³ximas 6h]
        [Por cada feature]
    }

    embed --> attention
    attention --> ffn
    ffn --> encoder
    encoder --> proj

    note right of attention
        **FunciÃ³n de AtenciÃ³n:**
        Captura dependencias temporales
        en las series de lluvia

        **Ventaja vs LSTM:**
        Paralelizable, captura
        relaciones de largo plazo
    end note
}

' ============================================
' GRAPH NEURAL NETWORK
' ============================================
package "ğŸ•¸ï¸ GRAPH NEURAL NETWORK (Espacial)" as gnn {
    rectangle "ConstrucciÃ³n\ndel Grafo" as graph_build {
        [Nodos = Zonas de Guayaquil]
        [Edges = Conexiones hidrolÃ³gicas]
        [Features = TopografÃ­a, predicciÃ³n lluvia]
    }

    rectangle "Graph Convolution\nLayers (GCN)" as gcn {
        [AgregaciÃ³n de vecinos]
        [h_i^(l+1) = Ïƒ(Î£ WÂ·h_j^(l) / |N(i)|)]
        [PropagaciÃ³n de informaciÃ³n]
    }

    rectangle "Graph Attention\nNetwork (GAT)" as gat {
        [Attention weights Î±_ij]
        [h_i = Ïƒ(Î£ Î±_ijÂ·WÂ·h_j)]
        [Aprendizaje de importancia]
    }

    rectangle "Message Passing" as mp {
        [3-5 capas de propagaciÃ³n]
        [InformaciÃ³n fluye entre zonas]
        [Simula propagaciÃ³n de agua]
    }

    graph_build --> gcn
    gcn --> gat
    gat --> mp

    note right of graph_build
        **Conexiones:**
        - Adyacencia geogrÃ¡fica
        - Flujo de alcantarillado
        - Pendiente topogrÃ¡fica
        - RÃ­os y esteros
    end note

    note right of mp
        **Message Passing:**
        Zona A inundada â†’
        propaga riesgo a zonas
        conectadas aguas abajo
    end note
}

' ============================================
' FUSION LAYER
' ============================================
rectangle "âš¡ FUSION LAYER\n(AtenciÃ³n Cruzada)" as fusion {
    [Transformer Output (temporal)]
    [GNN Output (espacial)]
    ---
    [Cross-Attention]
    [Combina predicciones]
    [temporales + espaciales]
}

' ============================================
' OUTPUT
' ============================================
package "ğŸ“ PREDICCIONES POR ZONA" as outputs {
    rectangle "ClasificaciÃ³n\nde Riesgo" as risk {
        [Probabilidad de inundaciÃ³n]
        [Nivel: Low/Medium/High/Critical]
        [Tiempo estimado (2-6h)]
        [Confianza del modelo]
    }

    rectangle "Output por Zona" as zone_output {
        [Zona Z001: Los Sauces â†’ 45% (Medium)]
        [Zona Z002: Guasmo â†’ 78% (High)]
        [Zona Z003: BastiÃ³n â†’ 15% (Low)]
        [... 840 zonas]
    }

    risk --> zone_output
}

' ============================================
' CONEXIONES PRINCIPALES
' ============================================
weather_data --> embed : "Ãšltimas 24h\n(96 timesteps)"
geo_data --> graph_build : "Grid espacial\n840 zonas"

proj --> fusion : "PredicciÃ³n\ntemporal"
mp --> fusion : "PropagaciÃ³n\nespacial"

fusion --> risk : "PredicciÃ³n\nintegrada"

' ============================================
' LEYENDA
' ============================================
legend right
    **Componentes Clave:**

    |= Color |= Significado |
    | <#LightBlue> | Input/Output |
    | <#LightGreen> | Procesamiento Temporal |
    | <#LightCoral> | Procesamiento Espacial |
    | <#Gold> | FusiÃ³n |

    **Flujo de InformaciÃ³n:**
    1. Series temporales â†’ Transformer (atenciÃ³n temporal)
    2. Datos geoespaciales â†’ GNN (propagaciÃ³n espacial)
    3. FusiÃ³n de ambos â†’ PredicciÃ³n final por zona

    **InnovaciÃ³n:**
    Combina lo mejor de ambos mundos:
    - Transformer: Dependencias temporales complejas
    - GNN: Relaciones espaciales y propagaciÃ³n
end legend

@enduml

' ============================================
' DIAGRAMA 2: MECANISMO DE ATENCIÃ“N DETALLADO
' ============================================

@startuml Transformer_Attention_Mechanism

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial

title Mecanismo de AtenciÃ³n en Transformer\n(Para predicciÃ³n de lluvia temporal)

!define MATRIX rectangle

package "Input: Serie Temporal 24h" as input {
    MATRIX "X = [xâ‚, xâ‚‚, ..., xâ‚‚â‚„]" as X {
        [tâ‚: 12mm, 25Â°C, 80%, 10km/h]
        [tâ‚‚: 15mm, 24Â°C, 82%, 12km/h]
        [...]
        [tâ‚‚â‚„: 8mm, 26Â°C, 75%, 8km/h]
    }
}

package "Linear Projections" as projections {
    MATRIX "Query (Q)" as Q {
        [Q = X Â· W_Q]
        [DimensiÃ³n: 24 x 128]
    }

    MATRIX "Key (K)" as K {
        [K = X Â· W_K]
        [DimensiÃ³n: 24 x 128]
    }

    MATRIX "Value (V)" as V {
        [V = X Â· W_V]
        [DimensiÃ³n: 24 x 128]
    }
}

MATRIX "Attention Scores" as scores {
    [Score = Q Â· K^T / âˆšd_k]
    [DimensiÃ³n: 24 x 24]
    ---
    **Matriz de AtenciÃ³n:**
    QuÃ© tanto cada timestep
    se relaciona con otros
}

MATRIX "Softmax" as softmax {
    [Weights = softmax(Score)]
    [Suma por fila = 1]
    ---
    **NormalizaciÃ³n:**
    Convierte scores a
    probabilidades
}

MATRIX "Weighted Values" as weighted {
    [Output = Weights Â· V]
    [DimensiÃ³n: 24 x 128]
    ---
    **CombinaciÃ³n:**
    Suma ponderada de valores
    segÃºn importancia
}

X --> Q
X --> K
X --> V

Q --> scores
K --> scores
scores --> softmax
softmax --> weighted
V --> weighted

note right of scores
    **IntuiciÃ³n:**
    Si llueve mucho en t=10,
    el modelo aprende a poner
    atenciÃ³n en t=8, t=9
    (horas previas relevantes)
end note

note right of weighted
    **Output:**
    RepresentaciÃ³n enriquecida
    de cada timestep considerando
    contexto temporal completo

    **Ventaja:**
    Captura patrones como:
    "lluvia intensa seguida de
    pico 2h despuÃ©s"
end note

@enduml

' ============================================
' DIAGRAMA 3: GNN MESSAGE PASSING
' ============================================

@startuml GNN_Message_Passing

skinparam backgroundColor #FEFEFE
skinparam defaultFontName Arial

title Graph Neural Network - Message Passing\n(PropagaciÃ³n espacial de inundaciÃ³n)

!define NODE circle
!define EDGE -->

package "Grafo de Zonas Guayaquil" as graph {
    NODE "Zona A\nGuasmo" as ZA {
        **Features:**
        Lluvia: 60mm
        ElevaciÃ³n: 2m
        Prob: 0.8
    }

    NODE "Zona B\nBastiÃ³n" as ZB {
        **Features:**
        Lluvia: 45mm
        ElevaciÃ³n: 5m
        Prob: 0.4
    }

    NODE "Zona C\nSauces" as ZC {
        **Features:**
        Lluvia: 30mm
        ElevaciÃ³n: 10m
        Prob: 0.2
    }

    NODE "Zona D\nKennedy" as ZD {
        **Features:**
        Lluvia: 35mm
        ElevaciÃ³n: 8m
        Prob: 0.3
    }
}

ZA EDGE ZB : "Conectadas\npor estero"
ZA EDGE ZC : "Flujo\naguas abajo"
ZB EDGE ZD : "Adyacentes"
ZC EDGE ZD : "Red de\nalcantarillado"

package "Message Passing (IteraciÃ³n 1)" as mp1 {
    rectangle "AgregaciÃ³n" as agg1 {
        **Zona B recibe mensajes:**
        - Zona A: h_A * w_AB
        - (h_A = features de A)
        - (w_AB = peso de conexiÃ³n)

        **ActualizaciÃ³n:**
        h_B' = Ïƒ(W Â· [h_B || Î£(mensajes)])
    }
}

package "Resultado Final (3-5 iteraciones)" as result {
    rectangle "Probabilidades Actualizadas" as probs {
        [Zona A: 0.8 â†’ 0.85] (alta, se mantiene)
        [Zona B: 0.4 â†’ 0.65] (â†‘ por vecindad con A)
        [Zona C: 0.2 â†’ 0.35] (â†‘ flujo desde A)
        [Zona D: 0.3 â†’ 0.45] (â†‘ vecindad con B)
    }

    note right of probs
        **Efecto de PropagaciÃ³n:**

        Zona A inundada (alta lluvia + baja elevaciÃ³n)
        â†’ propaga riesgo a zonas conectadas
        â†’ aunque tengan menos lluvia

        **Realista:**
        Modela cÃ³mo el agua fluye
        de zonas altas a bajas,
        y por red de alcantarillado
    end note
}

graph --> mp1
mp1 --> result

legend right
    **Tipos de Conexiones:**

    |= Tipo |= Peso |
    | Flujo gravitacional | Alto (pendiente) |
    | Alcantarillado | Medio |
    | Adyacencia simple | Bajo |

    **Iteraciones:**
    MÃ¡s iteraciones = mayor
    alcance de propagaciÃ³n

    3-5 capas tÃ­picamente
    suficientes para Guayaquil
end legend

@enduml

@startuml FloodGuard_Simple_Flow

skinparam backgroundColor #FEFEFE
title FloodGuard - Flujo Simplificado (Para TikTok)

rectangle "ğŸŒ§ï¸ INPUT\nPrecipitaciÃ³n\n24h pasadas" as input
rectangle "ğŸ§  TRANSFORMER\nAnÃ¡lisis temporal\nÂ¿CuÃ¡ndo lloverÃ¡?" as transformer
rectangle "ğŸ•¸ï¸ GNN\nPropagaciÃ³n espacial\nÂ¿DÃ³nde se inundarÃ¡?" as gnn
rectangle "âš¡ FUSIÃ“N\nCombina predicciones" as fusion
rectangle "ğŸ“ OUTPUT\nZonas en riesgo\n2-6h antes" as output

input --> transformer : "AtenciÃ³n\ntemporal"
transformer --> fusion : "PredicciÃ³n\nfutura"
input --> gnn : "Grafo\nespacial"
gnn --> fusion : "PropagaciÃ³n\nagua"
fusion --> output : "Alertas\npor zona"

note bottom of output
    **Ejemplo de Output:**

    ğŸŸ¢ Los Sauces: Riesgo Bajo (12%)
    ğŸŸ¡ Alborada: Riesgo Medio (45%)
    ğŸ”´ Guasmo: Riesgo Alto (78%) - â° 3.5h
    ğŸ”´ BastiÃ³n: Riesgo CrÃ­tico (92%) - â° 2h
end note

@enduml
